---
- hosts: primary
  tasks:
    - name: Get docker-compose ps
      shell: |
        ~/.local/bin/docker-compose ps 2>&1 > ps.log
      args:
        chdir: "{{ ansible_user_dir }}/tripleo-ci-reproducer"
      changed_when: true

    - name: Get docker-compose services logs
      shell: |
        ~/.local/bin/docker-compose logs --no-color {{ item }} 2>&1 > \
          {{ item }}.log
      args:
        chdir: "{{ ansible_user_dir }}/tripleo-ci-reproducer"
      changed_when: false
      whit_list:
        - zk
        - mysql
        - gerrit
        - logs
        - launcher
        - gerritconfig
        - scheduler
        - web
        - executor

    - name: Get docker-compose mergers logs
      shell: |
        ~/.local/bin/docker-compose logs --no-color {{ item }} 2>&1 > \
          {{ item }}.log
      args:
        chdir: "{{ ansible_user_dir }}/tripleo-ci-reproducer"
      changed_when: false
      with_items: "{{ lookup('sequence', 'count=' + ansible_processor_vcpus +
            'start=0 format=merger%d', wantlist=true) }}"

    - name: Copy files from {{ ansible_user_dir }} on node to log
      synchronize:
        src: '{{ ansible_user_dir }}/tripleo-ci-reproducer/'
        dest: '{{ zuul.executor.log_root }}/tripleo-ci-reproducer/'
        mode: pull
        copy_links: true
        verify_host: true
        rsync_opts:
          - "--exclude=secrets.env"
