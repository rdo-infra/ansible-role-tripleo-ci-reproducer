---
- name: run these tasks on the localhost
  hosts: 127.0.0.1
  connection: local
  vars:
    repro_role_path: >-
      {{ ansible_user_dir }}/{{ zuul.projects[
        'review.rdoproject.org/rdo-infra/ansible-role-tripleo-ci-reproducer'
        ].src_dir }}
  tasks:
    - name: set selinux to permissive
      selinux:
        policy: targeted
        state: permissive
      become: true

    - name: Gather needed facts
      setup:
        gather_subset: "!min,user_dir"
      when: ansible_user_dir is not defined

    - name: Install package ansible
      become: true
      package:
        name:
          - ansible
          - docker
          - python2-libselinux

    # https://bugzilla.redhat.com/show_bug.cgi?id=1448384
    # https://stackoverflow.com/questions/45335316/unable-to-configure-the-docker-daemon-with-file-etc-docker-daemon-json-eof
    - name: stat /etc/docker/daemon.json
      stat:
        path: /etc/docker/daemon.json
      register: daemon_stat

    - name: move docker daemon.json
      command: mv /etc/docker/daemon.json /etc/docker/daemon.json.bak
      become: true 
      when: daemon_stat.stat.exists

    - name: Install python dependencies
      pip:
        requirements: "{{ repro_role_path }}/requirements.txt"
        extra_args: --user

    - name: Create openstack config dir
      file:
        path: "{{ ansible_user_dir }}/.config/openstack/"
        state: directory
        mode: 0755

    - name: Ensure docker group is present
      group:
        name: docker
        state: present
      become: true

    - name: Check if user is in docker group
      command: "groups {{ ansible_user }}"
      register: user_groups
      changed_when: false

    - when: "'docker' not in user_groups.stdout"
      block:
        - name: Add user to docker group
          become: true
          user:
            name: '{{ ansible_user }}'
            groups: docker
            append: true
          register: groupadd

    - name: update user group manually w/o logging out
      shell: id -g && newgrp docker && id -g

    - name: Create docker configuration file
      become: true
      copy:
        content: |
          {
          "live-restore": true,
          "group": "docker",
          }
        dest: /etc/docker/daemon.json
      register: docker_config

    - name: Reload docker if config was changed
      become: true
      service:
        name: docker
        state: reloaded
      when: docker_config is changed

    - name: Start and enable docker
      become: true
      service:
        name: docker
        state: started
        enabled: true

    - name: Create roles directory
      file:
        path: "{{ ansible_user_dir }}/roles"
        state: directory

    - name: Link role
      file:
        src: "{{ repro_role_path }}"
        dest: "{{ ansible_user_dir }}/roles/tripleo-ci-reproducer"
        state: link
