---

- hosts: primary
  tasks:
    - name: Gather needed facts
      setup:
        gather_subset: "!min,user_dir,distribution"
      when:
        - ansible_user_dir is not defined
        - ansible_distribution is not defined
    - name: Check if pip is installed
      shell: command -v pip > /dev/null 2>&1
      ignore_errors: true
      changed_when: false
      register: pip_exists

    - when: pip_exists.rc != 0
      name: Install pip
      block:
        - when: ansible_distribution == "CentOS"
          name: Install EPEL
          become: true
          package:
            name: epel-release
        - name: Install pip
          become: true
          package:
            name:
              - python-pip

    # top_working_dir evaluates to "top_working_dir":
    - name: Set fact top_working_dir
      set_fact:
        top_working_dir: "{{ top_working_dir | default(playbook_dir + '/../..') }}"

    - name: Install python dependencies
      pip:
        requirements: "{{ top_working_dir }}/requirements.txt"
        extra_args: --user --force

    # Adding when to this command for linting error
    # https://github.com/ansible/ansible-lint/issues/165
    # Pipe true because bindep always returns code 1 (error)
    # when packages are missing
    - name: Discover packages that are not installed
      shell: |
        export PATH=$PATH:$HOME/.local/bin/
        bindep -b -f {{ top_working_dir }}/bindep.txt
      register: package_list
      failed_when: false

    - name: Install rpms from bindep
      become: true
      package:
        name: "{{ item }}"
        state: present
      with_items:
        - "{{ package_list.stdout_lines }}"

    - name: Find out docker group name
      shell: grep docker /etc/group | cut -d":" -f1 | head -1
      register: docker_group
      changed_when: false

    - when: not docker_group.stdout
      block:
        - name: Create docker group
          become: true
          group:
            name: docker
            state: present
        - name: Storing new created docker group
          set_fact:
            docker_group:
              stdout: docker

    - name: Check if user is in docker group
      command: "groups {{ ansible_user }}"
      register: user_groups
      changed_when: false

    - when: "docker_group.stdout not in user_groups.stdout"
      block:
        - name: Add user to docker group
          become: true
          user:
            name: '{{ ansible_user }}'
            groups: '{{ docker_group.stdout }}'
            append: true
          register: groupadd

    - name: reset ssh connection to allow user changes to affect
      meta: reset_connection

    - name: Check if docker configuration file already exists
      stat:
        path: /etc/docker/daemon.json
      register: docker_daemon_file

    - name: Check if the daemon.json contains the group line
      lineinfile:
        dest: /etc/docker/daemon.json
        line: "{'group': '{{ docker_group.stdout }}'}"
      check_mode: true
      register: docker_group_in_config
      when: docker_daemon_file.stat.exists|bool

    - name: Check if the daemon.json contains {}
      lineinfile:
        dest: /etc/docker/daemon.json
        line: "{}"
      check_mode: true
      register: empty_in_config
      when: docker_daemon_file.stat.exists|bool

    - name: Create docker configuration if file is missing
      become: true
      copy:
        content: |
          {
          "group": "{{ docker_group.stdout }}",
          }
        dest: /etc/docker/daemon.json
      register: docker_config
      when:
        - not docker_daemon_file.stat.exists|bool

    - name: Copy docker configuration if config is empty
      become: true
      copy:
        content: |
          {
          "group": "{{ docker_group.stdout }}",
          }
        dest: /etc/docker/daemon.json
      register: docker_config
      when:
        - empty_in_config is defined
        - empty_in_config is not changed

    - name: Create docker configuration file missing docker group
      become: true
      lineinfile:
        line: '{"group": "{{ docker_group.stdout }}"}'
        dest: /etc/docker/daemon.json
      register: docker_config
      when:
        - docker_group_in_config is defined
        - docker_group_in_config is changed

    - name: Reload docker if config was changed
      become: true
      service:
        name: docker
        state: reloaded
      when:
        - docker_config is defined
        - docker_config is changed

    - name: Start and enable docker
      become: true
      service:
        name: docker
        state: started
        enabled: true
