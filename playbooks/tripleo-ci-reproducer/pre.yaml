---
- hosts: primary
  vars:
    repro_role_path: >-
      {{ ansible_user_dir }}/{{ zuul.projects[
        'review.rdoproject.org/rdo-infra/ansible-role-tripleo-ci-reproducer'
        ].src_dir }}
  tasks:
    - name: Gather needed facts
      setup:
        gather_subset: "!min,user_dir"
      when: ansible_user_dir is not defined

    - name: Install package ansible
      become: true
      package:
        name:
          - ansible
          - docker

    - name: Install python dependencies
      pip:
        requirements: "{{ repro_role_path }}/requirements.txt"
        extra_args: --user

    - name: Create openstack config dir
      file:
        path: "{{ ansible_user_dir }}/.config/openstack/"
        state: directory
        mode: 0755

    - name: Find out docker group name
      shell: grep docker /etc/group | cut -d":" -f1 | head -1
      register: docker_group
      changed_when: false

    - name: Check if user is in docker group
      command: "groups {{ ansible_user }}"
      register: user_groups
      changed_when: false

    - block:
        - name: Add user to docker group
          become: true
          user:
            name: '{{ ansible_user }}'
            groups: '{{ docker_group.stdout }}'
            append: true
          register: groupadd

        - name: reset ssh connection to allow user changes to affect
          meta: reset_connection
      when:
        - docker_group.stdout != ''
        - docker_group.stdout not in user_groups.stdout

    - name: Start and enable docker
      become: true
      service:
        name: docker
        state: started
        enabled: true

    - name: Create roles directory
      file:
        path: "{{ ansible_user_dir }}/roles"
        state: directory

    - name: Link role
      file:
        src: "{{ repro_role_path }}"
        dest: "{{ ansible_user_dir }}/roles/tripleo-ci-reproducer"
        state: link
