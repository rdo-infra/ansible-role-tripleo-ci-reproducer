---

# Zuul executor has some limitations that prevents from running the role
# directly there so we have to generate a playbook and run it at the
# node

- hosts: primary
  vars:
    repro_role_path: >-
      {{ ansible_user_dir }}/{{ zuul.projects[
        'review.rdoproject.org/rdo-infra/ansible-role-tripleo-ci-reproducer'
        ].src_dir }}
  tasks:

    - name: Load docker vars
      become: true
      include_vars:
        file: /etc/docker/daemon.json
        name: docker
    - name: Add {{ mirror_fqdn }} to docker
      set_fact:
        mirrored_docker: "{{ docker | combine({
          'registry-mirrors': [mirror_fqdn]
        }) }}"
    - name: Write modified docker daemon config
      become: true
      copy:
        content: "{{ mirrored_docker | to_nice_json }}"
        dest: /etc/docker/daemon.json
    - name: Reload docker if config was changed
      become: true
      service:
        name: docker
        state: reloaded

    - name: Create roles directory
      file:
        path: "{{ ansible_user_dir }}/roles"
        state: directory
    - name: Link role
      file:
        src: "{{ repro_role_path }}"
        dest: "{{ ansible_user_dir }}/roles/tripleo-ci-reproducer"
        state: link
    - name: Generate reproducer playbook
      template:
        src: run.yaml.j2
        dest: "{{ ansible_user_dir }}/start.yaml"
    - name: Generate run script
      template:
        src: run.sh.j2
        dest: "{{ ansible_user_dir }}/run.sh"
        mode: 0755
    - name: Run reproducer
      command: "{{ ansible_user_dir }}/run.sh"
      changed_when: true
