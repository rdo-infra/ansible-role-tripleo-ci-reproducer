---
- hosts: primary
  vars:
    repro_role_path: >-
      {{ ansible_user_dir }}/{{ zuul.projects[
        'review.rdoproject.org/rdo-infra/ansible-role-tripleo-ci-reproducer'
        ].src_dir }}
  tasks:
    - name: Create roles directory
      file:
        path: "{{ ansible_user_dir }}/roles"
        state: directory
    - name: Link role
      file:
        src: "{{ repro_role_path }}"
        dest: "{{ ansible_user_dir }}/roles/tripleo-ci-reproducer"
        state: link
    - name: Create reproducer playbook
      vars:
        tq: 'git.openstack.org/openstack/tripleo-quickstart'
        tqe: 'git.openstack.org/openstack/tripleo-quickstart-extras'
        reproducer_playbook:
          - hosts: localhost
            tasks:
              - name: Start reproducer using host as the nodepool provider
                vars:
                  nodepool_provider: "{{ nodepool_provider }}"
                  upstream_gerrit_user: "{{ upstream_gerrit_user }}"
                  upstream_gerrit_key: "{{ tripleo_gerrit_key_name }}"
                  rdo_gerrit_user: "{{ rdo_gerrit_user }}"
                  rdo_gerrit_key: "{{ tripleo_gerrit_key_name }}"
                include_role:
                  name: tripleo-ci-reproducer
      copy:
        content: "{{ reproducer_playbook | to_nice_yaml }}"
        dest: "{{ ansible_user_dir }}/start.yaml"

    - name: Run reproducer
      command: |
        ~/.local/bin/ansible-playbook -vv {{ ansible_user_dir }}/start.yaml
      environment:
        ANSIBLE_LIBRARY: |
          {{ ansible_user_dir }}/{{ zuul.projects[tq].src_dir }}/library
        ANSIBLE_ROLES_PATH: |
          {{ ansible_user_dir }}/{{ zuul.projects[tq].src_dir }}/roles:
          {{ ansible_user_dir }}/{{ zuul.projects[tqe].src_dir }}/roles
      changed_when: true
      register: run_reproducer
    - debug:
        var: run_reproducer
