---
- name: Create tmp dir to clone testproject
  tempfile:
    state: directory
  register: testproject

- name: Clone testproject project
  git:
    repo: ssh://admin@localhost:29418/test1
    dest: "{{ testproject.path }}"

- name: Dump zuul.yaml
  copy:
    content: "{{ zuul_yaml | to_nice_yaml }}"
    dest: "{{ testproject.path }}/zuul.yaml"
    mode: 0644

- name: Push zuul.yaml to launch job
  shell:
    chdir: "{{ testproject.path }}"
    cmd: |
      pwd
      git remote add gerrit ssh://admin@localhost:29418/test1
      git add zuul.yaml
      git commit -m "Add job to launch"
      {% for review in depends_on|default([]) %}
      Depends-On: {{ review }}
      {% endfor %}
      git review
  changed_when: true

- name: Wait for job to finish
  uri:
    url: "http://localhost:9000/api/tenant/tripleo-ci-reproducer/status"
    method: GET
    return_content: true
    status_code: 200
    body_format: json
  register: zuul_status
  retries: 20
  delay: 10
  until: zuul_status.json.pipelines.0.change_queues != []
  changed_when: false
